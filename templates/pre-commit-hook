#!/bin/bash
#
# Pre-commit hook for skill repositories
# Prevents commits containing secrets or common issues
#
# Installation:
#   cp pre-commit-hook .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "Running skill pre-commit checks..."

ERRORS=0

# Get list of staged markdown files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.md$" || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}✓${NC} No markdown files staged"
    exit 0
fi

# Check for secrets in staged files
echo "Checking for secrets..."
for file in $STAGED_FILES; do
    # Check for API key patterns
    if git show ":$file" | grep -niE "(api[_-]?key|secret|password|token)\s*[=:]\s*['\"]?[a-zA-Z0-9]{16,}" 2>/dev/null | grep -v "example\|sample\|your[_-]" > /dev/null; then
        echo -e "${RED}✗${NC} Potential secret in: $file"
        ERRORS=$((ERRORS + 1))
    fi
    
    # Check for common API key prefixes
    if git show ":$file" | grep -niE "(sk-[a-zA-Z0-9]{20,}|ghp_[a-zA-Z0-9]{20,}|gho_[a-zA-Z0-9]{20,}|xai-[a-zA-Z0-9]{20,})" 2>/dev/null > /dev/null; then
        echo -e "${RED}✗${NC} API key pattern found in: $file"
        ERRORS=$((ERRORS + 1))
    fi
done

# Check for hardcoded paths
echo "Checking for hardcoded paths..."
for file in $STAGED_FILES; do
    if git show ":$file" | grep -niE "\/home\/[a-z]+" 2>/dev/null > /dev/null; then
        echo -e "${YELLOW}⚠${NC} Hardcoded /home/ path in: $file"
    fi
    if git show ":$file" | grep -niE "\/Users\/[a-zA-Z]+" 2>/dev/null > /dev/null; then
        echo -e "${YELLOW}⚠${NC} Hardcoded /Users/ path in: $file"
    fi
done

# Check for personal emails
echo "Checking for personal emails..."
for file in $STAGED_FILES; do
    if git show ":$file" | grep -niE "@(gmail|yahoo|hotmail|proton)\." 2>/dev/null > /dev/null; then
        echo -e "${YELLOW}⚠${NC} Personal email in: $file"
    fi
done

# Summary
if [ $ERRORS -gt 0 ]; then
    echo ""
    echo -e "${RED}━━━ COMMIT BLOCKED ━━━${NC}"
    echo "Found $ERRORS security issue(s)."
    echo "Fix issues or use --no-verify to bypass (not recommended)"
    exit 1
fi

echo -e "${GREEN}✓${NC} Pre-commit checks passed"
exit 0
